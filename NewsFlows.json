{
  "name": "NewsFlows",
  "nodes": [
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://vg.g210512.com/api/bot-users/session/{{ $('When Executed by Another Workflow').first().json.session_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\":\"rejected\"}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1280,
        400
      ],
      "id": "5732fb2a-4874-4117-a7d6-2347ad60b722",
      "name": "Guardar Veto Postgress",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('SET: Blocked Status').first().json.data.id }}/comentarios",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "comentario",
              "value": "={{ $json.reporte_final }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2288,
        -256
      ],
      "id": "9304871b-12cc-4bdd-bda1-cb4d6b23ec1f",
      "name": "HTTP Request1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const normalizedMessages = Array.isArray($json.chat_histories) ? $json.chat_histories : [];\n\n// Orden cronolÃ³gico\nconst items = [...normalizedMessages].reverse();\n\nconst normalizeMessage = (item) => {\n  const raw = item?.message ?? item ?? {};\n  const type = raw.type ?? raw.role ?? item?.type ?? 'unknown';\n  const content = raw.content ?? raw?.data?.content ?? item?.content ?? item?.data?.content ?? null;\n\n  return {\n    type,\n    content,\n    data: raw?.data && typeof raw.data === 'object' ? raw.data : { content },\n  };\n};\n\nlet reporte = \"ðŸš¨ REPORTE DE BLOQUEO - ÃšLTIMAS INTERACCIONES ðŸš¨\\n\\n\";\n\nfor (const item of items) {\n  const msg = normalizeMessage(item);\n\n  let actor = \"Desconocido\";\n  if (msg.type === 'human') actor = \"Usuario\";\n  else if (msg.type === 'ai') actor = \"Bot\";\n\n  // ValidaciÃ³n explÃ­cita de estructura esperada\n  const hasExpectedShape = typeof msg.type === 'string'\n    && (typeof msg.content === 'string' || typeof msg.data?.content === 'string');\n\n  let texto = msg.content || msg.data?.content || \"Sin texto\";\n\n  if (!hasExpectedShape) {\n    texto = `[Estructura inesperada] ${JSON.stringify(item)}`;\n  }\n\n  if (actor === \"Bot\" && typeof texto === 'string' && texto.includes(\"{\")) {\n    try {\n      const inicio = texto.indexOf('{');\n      const fin = texto.lastIndexOf('}') + 1;\n\n      if (inicio !== -1 && fin !== -1) {\n        const jsonStr = texto.substring(inicio, fin);\n        const objeto = JSON.parse(jsonStr);\n\n        if (objeto.respuesta) texto = objeto.respuesta;\n      }\n    } catch (e) {\n      // Si falla el parseo, dejamos el texto original\n    }\n  }\n\n  reporte += `ðŸ”´ ${actor}: ${texto}\\n`;\n}\n\nreturn {\n  json: {\n    reporte_final: reporte\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2080,
        -256
      ],
      "id": "0222802f-dd89-4456-992c-db8221d1e277",
      "name": "Formatear Conversacion"
    },
    {
      "parameters": {
        "url": "=https://crm.g210512.com/api/chat-histories/session/{{ $json.session_id }}?order=desc&limit=10",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {},
        "method": "GET"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1888,
        -256
      ],
      "id": "17c470ce-ea8e-42d4-bf7d-14333baaabcf",
      "name": "Get Story Chat",
      "credentials": {
        "httpBearerAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://vg.g210512.com/api/bot-users/session/{{ $('When Executed by Another Workflow').item.json.session_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\":\"blocked\"}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1536,
        -256
      ],
      "id": "e81a00c5-c8ab-4649-afba-9b465f1de49d",
      "name": "SET: Blocked",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('AI Cleaner - Recepcionista').item.json.accion }}",
                    "rightValue": "bloquear",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "557be052-61de-4151-9911-abf7f5404b31"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ðŸš« Bloquear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "170af834-dfb6-43a2-880d-3272a3d20933",
                    "leftValue": "={{ $('AI Cleaner - Recepcionista').item.json.accion }}",
                    "rightValue": "responder",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "âž¡ï¸ Responder"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c66d3aa2-4b2c-4b23-8fa0-7c0e0ca075ec",
                    "leftValue": "={{ $('AI Cleaner - Recepcionista').item.json.accion }}",
                    "rightValue": "rechazar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "âŒ Rechazar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "faae84b3-edce-4c6b-929e-ac1422d8784f",
                    "leftValue": "={{ $('AI Cleaner - Recepcionista').item.json.accion }}",
                    "rightValue": "transferir",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ðŸ”€ Transferir"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        976,
        288
      ],
      "id": "9f3e821a-b4d7-4825-8e4d-1d0fda02dbe4",
      "name": "Switch: Block or Continue"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When Executed by Another Workflow').item.json.session_id }}",
        "tableName": "=n8n_chat_histories",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2688,
        928
      ],
      "id": "9d5f75ec-4388-4a5c-a60c-adc4a4658ca7",
      "name": "Chat Memory",
      "credentials": {
        "postgres": {
          "id": "qyR2OAIR7tUEVcQf",
          "name": "Postgres-neon"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message }}",
        "options": {
          "systemMessage": "=Eres el Asistente de Bienvenida de Villanueva GarcÃ­a.\n\nTu funciÃ³n es clasificar la intenciÃ³n del mensaje del usuario y avanzar el onboarding mÃ­nimo obligatorio antes de transferir al flujo de inmuebles.\n\nOBJETIVO DE ONBOARDING (OBLIGATORIO)\n\nDebes obtener en este orden:\n\nNombre completo (Nombre + Apellido)\n\nTelÃ©fono (10 dÃ­gitos MX)\n\nConfirmar si es cliente o asesor\n\nâš ï¸ Aunque el usuario pregunte por inmuebles, si faltan datos del onboarding debes pedirlos primero.\n\nHERRAMIENTA OBLIGATORIA\n\nDebes consultar SIEMPRE la tabla Chat Memory para conocer el estado previo del usuario.\n\nMEMORIA (solo lectura para el AI)\n\nEn memoria pueden existir:\n\nveces_pidiendo_nombre (int)\n\nveces_pidiendo_telefono (int)\n\nSi no existen:\n\nAsÃºmelos como 0 solo para decidir.\n\nNO los escribas como hechos.\n\nSolo propone cambios mediante memoria_delta.\n\nINTENCIONES PERMITIDAS\n\nDebes devolver UNA SOLA:\n\nmisbehavior\n\npersonal_data\n\ngreetings\n\nproperty_inquiry\n\ngeneral_inquiry\n\nREGLAS DE PRIORIDAD (CRÃTICAS)\n\nEvalÃºa en este orden exacto:\n\nMisbehavior\nSi hay insulto, amenaza, lenguaje ofensivo o agresivo\nâ†’ intencion=\"misbehavior\"\nâ†’ accion=\"bloquear\"\n\nPersonal data (NUEVO)\nSi el mensaje contiene:\n\nun nombre completo vÃ¡lido, o\n\nun telÃ©fono vÃ¡lido,\naunque tambiÃ©n incluya saludo o preguntas\nâ†’ intencion=\"personal_data\"\n\nProperty inquiry\nSi el usuario quiere:\n\nver, rentar, comprar, visitar un inmueble\n\nprecio, ubicaciÃ³n, disponibilidad\n\nGreetings\nSi es solo saludo o cortesÃ­a:\n\nâ€œholaâ€, â€œbuenasâ€, â€œquÃ© talâ€, etc.\n\nGeneral inquiry\nCualquier otro mensaje\n\nâš ï¸ Nota clave:\nAunque la intenciÃ³n sea property_inquiry o general_inquiry, si faltan datos del onboarding debes pedirlos antes de continuar.\n\nDEFINICIONES ESTRICTAS\nNombre completo vÃ¡lido\n\nAl menos 2 palabras\n\nSolo letras\n\nEjemplo vÃ¡lido: \"Juan PÃ©rez\"\n\nâŒ No vÃ¡lido: \"Juan\", \"ðŸ¤–\", \"JP\"\n\nTelÃ©fono vÃ¡lido\n\nExactamente 10 dÃ­gitos\n\nPuede venir con espacios o guiones\n\nDebes normalizarlo a solo dÃ­gitos\n\nUsuario asesor\n\nSi menciona:\n\nâ€œasesorâ€, â€œagenteâ€, â€œbrokerâ€, â€œinmobiliariaâ€, â€œsoy asesorâ€, etc.\n\nPOLÃTICAS\n\nNunca ofrezcas alternativas de contacto.\n\nNunca inventes datos.\n\nSi no estÃ¡s seguro, deja el campo vacÃ­o.\n\nSi el usuario no entrega el mismo dato tras 3 intentos â†’ accion=\"rechazar\".\n\nFORMATO DE SALIDA (JSON ESTRICTO)\n\nâš ï¸ ÃšNICA SALIDA PERMITIDA. NO TEXTO EXTRA.\n\n{\n  \"respuesta\": \"\",\n  \"accion\": \"responder | transferir | rechazar | bloquear\",\n  \"intencion\": \"greetings | personal_data | property_inquiry | general_inquiry | misbehavior\",\n  \"datos\": {\n    \"nombre\": \"\",\n    \"telefono\": \"\",\n    \"api_id\": {{ $json.api_contact_id }}\n  },\n  \"memoria_delta\": {\n    \"pide_nombre\": false,\n    \"pide_telefono\": false\n  }\n}\n\nDATOS RECIBIDOS (INPUT ACTUAL)\n\nNombre actual: {{ $json.nombre }}\n\nTelÃ©fono actual: {{ $json.session_id.slice(3) }}\n\nMensaje: {{ $json.message }}\n\nAPI ID: {{ $json.api_contact_id }}\n\nLÃ“GICA DE DECISIÃ“N\n0) FILTRO DE GROSERÃAS\n\nSi hay falta de respeto:\n\nrespuesta: \"No puedo continuar debido al lenguaje utilizado.\"\n\naccion: \"bloquear\"\n\nintencion: \"misbehavior\"\n\ndatos: vacÃ­os\n\nmemoria_delta: ambos false\n\n1) EVALUAR NOMBRE COMPLETO\n\nSi el nombre actual:\n\nes vacÃ­o / null\n\ncontiene emojis\n\nno cumple definiciÃ³n\n\nEntonces:\n\nSi veces_pidiendo_nombre >= 3 â†’\n\naccion: \"rechazar\"\n\nrespuesta breve y neutral\n\nSi el mensaje contiene nombre completo vÃ¡lido â†’\n\nguardar en datos.nombre\n\nintencion=\"personal_data\"\n\ncontinuar a telÃ©fono\n\nSi NO contiene nombre â†’\n\nrespuesta EXACTA:\n\n\"Bienvenido a Inmobiliaria Villanueva GarcÃ­a, para atenderte personalmente indÃ­came tu nombre completo por favor (Nombre y Apellido)\"\n\nmemoria_delta.pide_nombre = true\n\n2) EVALUAR TELÃ‰FONO\n\nSi ya hay nombre pero telÃ©fono es vacÃ­o o invÃ¡lido:\n\nSi veces_pidiendo_telefono >= 3 â†’\n\naccion: \"rechazar\"\n\nSi el mensaje contiene telÃ©fono vÃ¡lido â†’\n\nnormalizar a 10 dÃ­gitos\n\nguardar en datos.telefono\n\nintencion=\"personal_data\"\n\nSi NO contiene telÃ©fono â†’\n\nrespuesta:\n\n\"Perfecto, ahora compÃ¡rteme tu nÃºmero de telÃ©fono a 10 dÃ­gitos, por favor.\"\n\nmemoria_delta.pide_telefono = true\n\n3) SI YA HAY NOMBRE Y TELÃ‰FONO\n\nPregunta:\n\n\"Â¿Buscas para ti o eres asesor?\"\n\nSi indica asesor â†’\n\naccion: \"rechazar\"\n\nrespuesta: \"Lo siento, este canal es solo para clientes.\"\n\nSi indica cliente / busca para sÃ­ â†’\n\naccion: \"transferir\"\n\nrespuesta: \"Perfecto, Â¿quÃ© inmueble te interesa?\"\n\nSi no es claro â†’\n\naccion: \"responder\"\n\nrepetir la pregunta\n\nRECORDATORIOS FINALES\n\nSiempre JSON vÃ¡lido\n\nNunca texto fuera del JSON\n\nNunca inventar datos\n\npersonal_data tiene prioridad cuando el usuario manda nombre o telÃ©fono"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2544,
        720
      ],
      "id": "57ff7c81-ffc6-43c2-bf29-21b94a625c46",
      "name": "AI: Recepcionista"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://vg.g210512.com/api/bot-users/session/{{ $('When Executed by Another Workflow').first().json.session_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\":\"prospecting\"}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1264,
        736
      ],
      "id": "ada98233-3004-4ffa-aa36-cd0fb51b20e3",
      "name": "SET prospecting status",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('When Executed by Another Workflow').item.json.session_id }}",
        "text": "={{ $('AI Cleaner - Recepcionista').item.json.respuesta }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1504,
        400
      ],
      "id": "2eca8f28-66b8-4ec6-9959-0917f38f7f98",
      "name": "Reject Chat",
      "webhookId": "4879cb5d-acdf-480f-ac53-2e7e6b365fe5",
      "credentials": {
        "telegramApi": {
          "id": "miuzXVpC7N3HQebh",
          "name": "RAG BOT"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('When Executed by Another Workflow').item.json.session_id }}",
        "text": "={{ $('AI Cleaner - Recepcionista').item.json.respuesta }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1520,
        736
      ],
      "id": "115ffe72-acb0-4fd2-a17a-3f0f4b1b1733",
      "name": "Transfer Chat",
      "webhookId": "4879cb5d-acdf-480f-ac53-2e7e6b365fe5",
      "credentials": {
        "telegramApi": {
          "id": "miuzXVpC7N3HQebh",
          "name": "RAG BOT"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-nano",
          "mode": "list",
          "cachedResultName": "gpt-5-nano"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2512,
        992
      ],
      "id": "1743f6bf-dc28-4bf1-aeb5-8dbed0639123",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "g8OPzRDvvB6YO7mf",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('AI Cleaner - Recepcionista').item.json.api_id }}/comentarios\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "comentario",
              "value": "={{ $json.content.parts[0].text }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2048,
        400
      ],
      "id": "b543e5f2-0792-471b-a2b6-78b9734acd1f",
      "name": "API: Add Comment1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "url": "=https://crm.g210512.com/api/chat-histories/session/{{ $('When Executed by Another Workflow').first().json.session_id }}?order=desc&limit=10",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {},
        "method": "GET"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        1760,
        560
      ],
      "id": "cccfbfd2-83af-4498-91fc-2680ca3cbd45",
      "name": "GET: Chat Histories",
      "credentials": {
        "httpBearerAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $json.api_contact_id }}/estado",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "estado",
              "value": "blocked"
            },
            {
              "name": "nombre",
              "value": "={{ $('When Executed by Another Workflow').first().json.nombre }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1712,
        -256
      ],
      "id": "5bcbc588-da42-4e6d-a9f7-cd1f95a803d4",
      "name": "SET: Blocked Status",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('AI Cleaner - Recepcionista').item.json.api_id }}/estado",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "estado",
              "value": "rejected"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2256,
        400
      ],
      "id": "a9d89e77-f5d1-48b4-94f1-6cac91688a40",
      "name": "SET: Blocked Status1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('AI Cleaner - Recepcionista').item.json.api_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"nombre\": \"{{ $('AI Cleaner - Recepcionista').item.json.nuevo_nombre ? $('AI Cleaner - Recepcionista').item.json.nuevo_nombre + \" - ðŸ¤–\" : \"ðŸ¤– - Nuevo Contacto\" }}\",\n  \"telefono\": \"{{ $('Query de ActualizaciÃ³n Inteligente').item.json.telefono_real }}\",\n  \"estado\": \"nuevo\",\n  \"fuente\": \"ðŸ¤– - WhatsApp Bot\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        80
      ],
      "id": "a4045a35-4b63-4484-849c-25652474b439",
      "name": "API: Update Contact",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=https://vg.g210512.com/api/v1/contactos/{{ $('AI Cleaner - Recepcionista').item.json.api_id }}/estado",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "estado",
              "value": "={{ \"en_contacto\" }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1744,
        736
      ],
      "id": "0a452e6c-0249-4a05-bf1a-b67e9a1a164f",
      "name": "SET: Prospecting Status",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================\n// AI Cleaner - Recepcionista\n// Code node v2 (return array)\n// ============================\n\n// 1) Texto devuelto por el agente (puede traer JSON o texto sucio)\nconst textoIA = $input.item.json.output || \"\";\n\n// 2) Datos base desde el Trigger (siempre disponibles en tu flujo)\nlet trigger = {};\ntry {\n  const arr = $items(\"When Executed by Another Workflow\");\n  trigger = (arr && arr[0] && arr[0].json) ? arr[0].json : {};\n} catch (e) {\n  trigger = {};\n}\n\n// Helpers\nconst limpiarDato = (valor) => {\n  if (valor === undefined || valor === null) return null;\n  if (typeof valor === \"string\") {\n    const v = valor.trim();\n    if (!v) return null;\n    if (v.toUpperCase() === \"PENDIENTE\") return null;\n    return v;\n  }\n  return valor;\n};\n\nconst normalizarTelefono10 = (valor) => {\n  if (!valor) return null;\n  const digits = String(valor).replace(/\\D/g, \"\");\n  // Si viene con +52 o 52 al inicio, recortamos a Ãºltimos 10\n  if (digits.length > 10) return digits.slice(-10);\n  if (digits.length === 10) return digits;\n  return null;\n};\n\n// Extraer un JSON embebido dentro de texto\nconst extraerJson = (texto) => {\n  const inicio = texto.indexOf(\"{\");\n  const fin = texto.lastIndexOf(\"}\") + 1;\n  if (inicio === -1 || fin === -1 || fin <= inicio) return null;\n  const jsonLimpio = texto.substring(inicio, fin);\n  return JSON.parse(jsonLimpio);\n};\n\n// 3) Defaults (si el JSON viene sucio o falla el parseo)\nlet resultado = {\n  // salida conversacional\n  respuesta: textoIA,\n  accion: \"responder\",\n  intencion: null,\n\n  // para tu pipeline actual\n  nuevo_nombre: trigger.nombre ?? null,\n  nuevo_telefono: trigger.telefono_real ?? null,\n  nuevo_rol: null,\n  api_id: trigger.api_contact_id ?? null,\n\n  // nuevo: control de memoria (para que un nodo posterior aplique incrementos)\n  memoria_delta: {\n    pide_nombre: false,\n    pide_telefono: false\n  }\n};\n\ntry {\n  const objeto = extraerJson(textoIA);\n\n  if (objeto && typeof objeto === \"object\") {\n    // Campos principales\n    if (typeof objeto.respuesta === \"string\" && objeto.respuesta.trim()) {\n      resultado.respuesta = objeto.respuesta.trim();\n    }\n    if (typeof objeto.accion === \"string\" && objeto.accion.trim()) {\n      resultado.accion = objeto.accion.trim();\n    }\n\n    // intencion (nuevo)\n    if (typeof objeto.intencion === \"string\" && objeto.intencion.trim()) {\n      resultado.intencion = objeto.intencion.trim();\n    }\n\n    // memoria_delta (nuevo)\n    const md = objeto.memoria_delta || {};\n    if (typeof md.pide_nombre === \"boolean\") resultado.memoria_delta.pide_nombre = md.pide_nombre;\n    if (typeof md.pide_telefono === \"boolean\") resultado.memoria_delta.pide_telefono = md.pide_telefono;\n\n    // Datos (compat: datos_capturados)\n    const datos = objeto.datos || objeto.datos_capturados || {};\n\n    const nombre = limpiarDato(datos.nombre);\n    const telefonoRaw = limpiarDato(datos.telefono);\n    const rol = limpiarDato(datos.rol);\n    const apiId = limpiarDato(datos.api_id);\n\n    if (nombre) resultado.nuevo_nombre = nombre;\n\n    const telNorm = normalizarTelefono10(telefonoRaw);\n    if (telNorm) resultado.nuevo_telefono = telNorm;\n\n    if (rol) resultado.nuevo_rol = rol;\n\n    // Mantener api_id del trigger si no viene en la respuesta\n    if (apiId !== null) resultado.api_id = apiId;\n  }\n} catch (e) {\n  // si falla parseo, se quedan defaults\n}\n\n// 4) GarantÃ­as mÃ­nimas: normaliza telÃ©fono si venÃ­a del trigger\nresultado.nuevo_telefono = normalizarTelefono10(resultado.nuevo_telefono) || null;\n\n// IMPORTANTE: Code node v2 devuelve un array de items\nreturn [{ json: resultado }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2880,
        736
      ],
      "id": "7a0ffd7a-6a24-4974-9ee4-945ba2b42bfc",
      "name": "AI Cleaner - Recepcionista"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-5-nano",
          "mode": "list",
          "cachedResultName": "GPT-5-NANO"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "Tu objetivo es generar un resumen legible para el ser humano del contexto que obtienes del dataset de rechazo: herramienta GET: Chat Histories (chat-histories con order=desc y limit=10, Ãºltimas interacciones). Puedes usar emojis para marcar IA ðŸ¤– y humano ðŸ‘¤, y numerar interacciones cuando aporte claridad.\nLo primero que me tienes que indicar es: âŒ Rechazado, motivo: .... (Siempre al inicio y con motivo de rechazo, usando el dataset de rechazo).\nEvita textos como 'AquÃ­ estÃ¡ tu resumen'; redacta natural, como si me platicaras quÃ© pasÃ³."
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2.1,
      "position": [
        1712,
        400
      ],
      "id": "d6d789a5-1c98-44e7-a9c8-4ac9da1a38aa",
      "name": "AI: Generate Reject Message",
      "credentials": {
        "openAiApi": {
          "id": "g8OPzRDvvB6YO7mf",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://vg.g210512.com/api/bot-users/session/{{ $('Query de ActualizaciÃ³n Inteligente').item.json.session_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {},
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"bot_status\":\"free\"}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2160,
        80
      ],
      "id": "962af4e6-e899-465c-887f-4515956a6731",
      "name": "SET: BOT FREE2",
      "credentials": {
        "httpHeaderAuth": {
          "id": "rzmCtJN8Vtwv6AO3",
          "name": "API Key Inmuebles"
        }
      }
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "session_id"
            },
            {
              "name": "status"
            },
            {
              "name": "api_contact_id",
              "type": "number"
            },
            {
              "name": "nombre"
            },
            {
              "name": "telefono_real"
            },
            {
              "name": "bot_status"
            },
            {
              "name": "rejected_count",
              "type": "number"
            },
            {
              "name": "questionnaire_status"
            },
            {
              "name": "property_id"
            },
            {
              "name": "count_outcontext",
              "type": "number"
            },
            {
              "name": "message"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -688,
        336
      ],
      "id": "f7125ab4-72bf-411f-8b73-fcb6a08f8455",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=892218773979929",
        "recipientPhoneNumber": "={{ $json.session_id }}",
        "textBody": "={{ $json.last_bot_reply }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1728,
        80
      ],
      "id": "8810f1b1-17c3-45d6-a503-323f6662dc80",
      "name": "Send message",
      "webhookId": "f10bdfda-5d5f-4e89-814a-5e96d962694e",
      "notesInFlow": false,
      "executeOnce": false,
      "alwaysOutputData": false,
      "credentials": {
        "whatsAppApi": {
          "id": "s0OzaeWmw3lzqhNG",
          "name": "WhatsApp - testing v2"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.last_intencion }}",
                    "rightValue": "general_inquiry",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2e005d8e-93e5-4787-b124-7025bd6f8eca"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "General Inq"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "c88f89d9-773f-4614-b57c-7239cae52ff2",
                    "leftValue": "={{ $json.last_intencion }}",
                    "rightValue": "personal_data",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Data"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "08ec601a-9937-4174-ae39-e54e1a71206f",
                    "leftValue": "={{ $json.last_intencion }}",
                    "rightValue": "greetings",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Grettings"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1344,
        80
      ],
      "id": "da527720-c8ab-4596-9b00-d4c6979eeaa8",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "=892218773979929",
        "recipientPhoneNumber": "={{ $json.session_id }}",
        "textBody": "={{ $json.last_bot_reply }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        1360,
        -256
      ],
      "id": "c3b97de3-6772-42da-ac33-52029eb154ae",
      "name": "Send message1",
      "webhookId": "f10bdfda-5d5f-4e89-814a-5e96d962694e",
      "notesInFlow": false,
      "executeOnce": false,
      "alwaysOutputData": false,
      "credentials": {
        "whatsAppApi": {
          "id": "s0OzaeWmw3lzqhNG",
          "name": "WhatsApp - testing v2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "cd5160f0-41bc-43a2-9aae-38e159cf97de",
              "name": "chat_histories",
              "value": "={{ Array.isArray($json.data) ? $json.data : (Array.isArray($json) ? $json : []) }}",
              "type": "array"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1984,
        -256
      ],
      "id": "1ea15a66-d0bf-481d-a2f2-d1cc3bfaf3c4",
      "name": "Set: Chat Histories Shape"
    }
  ],
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "session_id": "5215559177781",
          "status": "new",
          "api_contact_id": 934,
          "nombre": "ðŸ¤–2.0 - alfgow",
          "bot_status": "processing",
          "rejected_count": 0,
          "questionnaire_status": "none",
          "count_outcontext": 0,
          "message": "Tienen casas en la roma?"
        }
      }
    ],
    "Clasificador de IntenciÃ³n": [
      {
        "json": {
          "output": [
            {
              "id": "msg_0d230214a08e50eb00695eeb176fb0819eb2246c8cec1577fa",
              "type": "message",
              "status": "completed",
              "content": [
                {
                  "type": "output_text",
                  "annotations": [],
                  "logprobs": [],
                  "text": "{\n  \"intencion\": \"property_inquiry\",\n  \"response\": \"\"\n}"
                }
              ],
              "role": "assistant"
            }
          ]
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "AI Cleaner": [
      {
        "json": {
          "intencion": "property_inquiry",
          "response": ""
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "Execute a SQL query": [
      {
        "json": {
          "session_id": "5215559177781",
          "status": "new",
          "api_contact_id": 934,
          "nombre": "Alfonso Villanueva",
          "created_at": "2026-01-03T05:39:59.080Z",
          "updated_at": "2026-01-07T22:29:18.600Z",
          "telefono_real": "null",
          "rol": "null",
          "bot_status": "free",
          "rejected_count": 0,
          "questionnaire_status": "none",
          "property_id": null,
          "count_outcontext": 0,
          "veces_pidiendo_nombre": 2,
          "veces_pidiendo_telefono": 4,
          "last_intencion": "personal_data",
          "last_accion": "responder",
          "last_bot_reply": "Perfecto, ahora compÃ¡rteme tu nÃºmero de telÃ©fono a 10 dÃ­gitos, por favor."
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Guardar Veto Postgress": {
      "main": [
        [
          {
            "node": "Reject Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Conversacion": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Story Chat": {
      "main": [
        [
          {
            "node": "Set: Chat Histories Shape",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET: Blocked": {
      "main": [
        [
          {
            "node": "SET: Blocked Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Block or Continue": {
      "main": [
        [
          {
            "node": "Send message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Veto Postgress",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SET prospecting status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI: Recepcionista",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI: Recepcionista": {
      "main": [
        [
          {
            "node": "AI Cleaner - Recepcionista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET prospecting status": {
      "main": [
        [
          {
            "node": "Transfer Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reject Chat": {
      "main": [
        [
          {
            "node": "AI: Generate Reject Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transfer Chat": {
      "main": [
        [
          {
            "node": "SET: Prospecting Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI: Recepcionista",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "API: Add Comment1": {
      "main": [
        [
          {
            "node": "SET: Blocked Status1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET: Chat Histories": {
      "ai_tool": [
        [
          {
            "node": "AI: Generate Reject Message",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "SET: Blocked Status": {
      "main": [
        [
          {
            "node": "Get Story Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API: Update Contact": {
      "main": [
        [
          {
            "node": "SET: BOT FREE2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Cleaner - Recepcionista": {
      "main": [
        [
          {
            "node": "Switch: Block or Continue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI: Generate Reject Message": {
      "main": [
        [
          {
            "node": "API: Add Comment1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "AI: Recepcionista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message": {
      "main": [
        [
          {
            "node": "API: Update Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send message1": {
      "main": [
        [
          {
            "node": "SET: Blocked",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set: Chat Histories Shape": {
      "main": [
        [
          {
            "node": "Formatear Conversacion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "c4ddc849-00a5-4004-82b6-f323e645ea2c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "37571b6e3b06c0ce894d50931b94c0b80b70f40d5b859a8ce717ce6c0e3d4b9d"
  },
  "id": "JN2MAz79dRGE2RqZ",
  "tags": [
    {
      "updatedAt": "2026-01-03T05:21:43.395Z",
      "createdAt": "2026-01-03T05:21:43.395Z",
      "id": "CGZf0gxA5685L0Mc",
      "name": "2.0"
    }
  ]
}
